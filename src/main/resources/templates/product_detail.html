<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title th:text="${product.name} + ' - 36 Store'">Chi tiết sản phẩm</title>
    <style>
        /* --- Giữ nguyên toàn bộ CSS như bạn có --- */
        .product-image {max-width:100%;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.1);transition:transform .3s ease;}
        .product-image:hover {transform:scale(1.02);}
        .product-info {background:white;padding:25px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1);}
        .option-btn.active {transform:scale(1.05);box-shadow:0 0 0 2px #007bff;}
        .stock-info{font-size:.9rem;padding:5px 10px;border-radius:5px;}
        .in-stock{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
        .out-of-stock{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                <li class="breadcrumb-item"><a th:href="@{/products}">Sản phẩm</a></li>
                <li class="breadcrumb-item active" th:text="${product.name}"></li>
            </ol>
        </nav>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div th:if="${product.imageUrl}">
                    <img th:src="${product.imageUrl}" class="product-image img-fluid" alt="Ảnh sản phẩm">
                </div>
                <div th:if="${product.imageUrl == null or product.imageUrl == ''}" class="no-image">
                    <span>Chưa có ảnh</span>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="product-info">
                    <h1 class="fw-bold mb-3" th:text="${product.name}"></h1>
                    <div class="product-meta small text-muted mb-3">
                        <div><strong>Danh mục:</strong> <span th:text="${product.category?.name ?: 'Chưa phân loại'}"></span></div>
                        <div><strong>Thương hiệu:</strong> <span th:text="${product.brand?.name ?: 'Không xác định'}"></span></div>
                    </div>

                    <!-- Chọn màu -->
                    <div class="mb-3">
                        <strong>Chọn màu:</strong>
                        <div>
                            <button type="button"
                                    th:each="color : ${availableColors}"
                                    th:text="${color.name}"
                                    th:data-color-id="${color.id}"
                                    class="btn btn-outline-dark me-2 mb-2 option-btn color-btn"
                                    th:onclick="selectColor(this)">
                            </button>
                        </div>
                    </div>

                    <!-- Chọn kích thước -->
                    <div class="mb-3">
                        <strong>Chọn kích thước:</strong>
                        <div>
                            <button type="button"
                                    th:each="size : ${availableSizes}"
                                    th:text="${size.name}"
                                    th:data-size-id="${size.id}"
                                    class="btn btn-outline-secondary me-2 mb-2 option-btn size-btn"
                                    th:onclick="selectSize(this)">
                            </button>
                        </div>
                    </div>

                    <!-- Giá + tồn kho -->
                    <div class="price-section mb-4">
                        <h3 id="price-display" class="text-danger fw-bold mb-2"
                            th:text="${#numbers.formatDecimal(product.variants[0].price,0,'COMMA',0,'POINT')} + ' VNĐ'"></h3>
                        <div class="d-flex align-items-center">
                            <label for="quantity" class="me-2 fw-semibold">Số lượng:</label>
                            <input type="number" id="quantity" value="1" min="1"
                                   th:max="${product.variants[0].quantity}"
                                   class="form-control text-center mx-2" style="width:80px;">
                            <span id="stock-display" class="stock-info in-stock"
                                  th:text="'Còn ' + ${product.variants[0].quantity} + ' sản phẩm'"></span>
                        </div>
                    </div>

                    <!-- Form thêm vào giỏ -->
                    <form th:action="@{/cart/add}" method="post" id="addToCartForm">
                        <input type="hidden" id="variantId" name="variantId" th:value="${variants[0].id}">
                        <input type="hidden" id="formQuantity" name="quantity" value="1">
                        <button type="submit" id="addToCartBtn"
                                class="btn btn-dark w-100"
                                th:if="${user != null && user.role?.toUpperCase() == 'CUSTOMER'}">
                            <i class="fa-solid fa-cart-plus me-2"></i>Thêm vào giỏ
                        </button>
                        <div th:unless="${user != null && user.role?.toUpperCase() == 'CUSTOMER'}"
                             class="alert alert-warning text-center mt-3">
                            <a th:href="@{/auth/login}" class="btn btn-primary btn-sm">Đăng nhập</a> để mua hàng
                        </div>
                    </form>

                    <div class="text-center mt-4">
                        <a th:href="@{/products}" class="btn btn-outline-secondary">
                            <i class="fa-solid fa-arrow-left me-2"></i>Quay lại
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPT -->
<script th:inline="javascript">
    const variants = /*[[${#objects.toJson(variants)}]]*/ [];
    let selectedColorId = null;
    let selectedSizeId = null;
    let currentVariant = variants.length ? variants[0] : null;

    console.log("Variants:", variants);

    function updateVariant() {
        if (selectedColorId || selectedSizeId) {
            currentVariant = variants.find(v => {
                const c = !selectedColorId || (v.color && v.color.id == selectedColorId);
                const s = !selectedSizeId || (v.size && v.size.id == selectedSizeId);
                return c && s;
            });
        } else currentVariant = variants.length ? variants[0] : null;

        const price = document.getElementById("price-display");
        const stock = document.getElementById("stock-display");
        const qty = document.getElementById("quantity");
        const addBtn = document.getElementById("addToCartBtn");

        if (currentVariant) {
            document.getElementById("variantId").value = currentVariant.id;
            price.textContent = new Intl.NumberFormat('vi-VN').format(currentVariant.price) + " VNĐ";

            const stockQty = currentVariant.quantity;
            qty.max = stockQty;
            qty.disabled = stockQty <= 0;
            stock.textContent = stockQty > 0 ? `Còn ${stockQty} sản phẩm` : "Hết hàng";
            stock.className = stockQty > 0 ? "stock-info in-stock" : "stock-info out-of-stock";

            addBtn.disabled = stockQty <= 0;
            addBtn.innerHTML = stockQty > 0
                ? '<i class="fa-solid fa-cart-plus me-2"></i>Thêm vào giỏ'
                : '<i class="fa-solid fa-times me-2"></i>Hết hàng';
        } else {
            price.textContent = "Tùy chọn không khả dụng";
            stock.textContent = "Không có sản phẩm";
            stock.className = "stock-info out-of-stock";
            qty.disabled = true;
            addBtn.disabled = true;
            addBtn.innerHTML = '<i class="fa-solid fa-times me-2"></i>Tùy chọn không khả dụng';
        }
    }

    window.selectColor = function(btn) {
        document.querySelectorAll(".color-btn").forEach(b => b.classList.remove("active","btn-dark"));
        btn.classList.add("active","btn-dark");
        selectedColorId = btn.getAttribute("data-color-id");
        updateVariant();
    };

    window.selectSize = function(btn) {
        document.querySelectorAll(".size-btn").forEach(b => b.classList.remove("active","btn-secondary"));
        btn.classList.add("active","btn-secondary");
        selectedSizeId = btn.getAttribute("data-size-id");
        updateVariant();
    };

    document.getElementById("quantity").addEventListener("input", e => {
        const max = parseInt(e.target.max) || 1;
        const val = Math.max(1, Math.min(max, parseInt(e.target.value) || 1));
        e.target.value = val;
        document.getElementById("formQuantity").value = val;
    });
</script>
</body>
</html>
